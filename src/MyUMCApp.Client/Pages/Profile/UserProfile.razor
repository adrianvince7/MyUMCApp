@page "/profile"
@using MyUMCApp.Shared.Models.Auth
@using MyUMCApp.Shared.Services
@using MyUMCApp.Client.Auth
@using MyUMCApp.Client.Services
@using Microsoft.AspNetCore.Components.Forms
@using MyUMCApp.Client.Components.Profile
@using MyUMCApp.Client.Components.Common
@attribute [Authorize(Policy = AuthorizationPolicies.RequireActiveUser)]
@inject IAuthService AuthService
@inject IProfilePictureService ProfilePictureService
@inject NavigationManager NavigationManager

<div class="profile-container">
    <div class="profile-header">
        <h1>My Profile</h1>
        @if (!string.IsNullOrEmpty(_successMessage))
        {
            <div class="alert alert-success">@_successMessage</div>
        }
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger">@_errorMessage</div>
        }
    </div>

    @if (_profile != null)
    {
        <div class="profile-content">
            <div class="profile-section">
                <div class="profile-picture">
                    @if (!string.IsNullOrEmpty(_profile.ProfilePictureUrl))
                    {
                        <ProgressiveImage 
                            Src="@_profile.ProfilePictureUrl"
                            ThumbnailUrl="@GetThumbnailUrl(_profile.ProfilePictureUrl)"
                            Alt="Profile Picture"
                            Width="150px"
                            Height="150px"
                            BorderRadius="50%" />
                    }
                    else
                    {
                        <div class="profile-picture-placeholder">
                            @_profile.FirstName[0]@_profile.LastName[0]
                        </div>
                    }
                    <InputFile OnChange="HandleFileSelected" accept=".jpg,.jpeg,.png,.gif,.webp" class="d-none" id="fileInput" />
                    <button class="btn btn-outline-primary mt-2" @onclick="HandleUploadPicture">
                        @if (_isUploadingPicture)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span>Uploading...</span>
                        }
                        else
                        {
                            <span>Change Picture</span>
                        }
                    </button>
                </div>

                @if (_showImageCropper)
                {
                    <div class="image-cropper-modal">
                        <div class="modal-overlay"></div>
                        <div class="modal-content">
                            <h3>Crop Profile Picture</h3>
                            <ImageCropper 
                                ImageUrl="@_selectedImageUrl"
                                OnCropComplete="HandleCropComplete"
                                OnCancel="() => _showImageCropper = false" />
                        </div>
                    </div>
                }

                @if (_showImageFilters)
                {
                    <div class="image-filters-modal">
                        <div class="modal-overlay"></div>
                        <div class="modal-content">
                            <h3>Apply Filters</h3>
                            <ImageFilters 
                                ImageUrl="@_selectedImageUrl"
                                OnFilterComplete="HandleFilterComplete"
                                OnCancel="() => _showImageFilters = false" />
                        </div>
                    </div>
                }

                <EditForm Model="@_profile" OnValidSubmit="HandleUpdateProfile">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="form-group">
                        <label for="firstName">First Name</label>
                        <InputText id="firstName" class="form-control" @bind-Value="_profile.FirstName" />
                    </div>

                    <div class="form-group">
                        <label for="lastName">Last Name</label>
                        <InputText id="lastName" class="form-control" @bind-Value="_profile.LastName" />
                    </div>

                    <div class="form-group">
                        <label for="email">Email</label>
                        <InputText id="email" class="form-control" @bind-Value="_profile.Email" disabled />
                    </div>

                    <div class="form-group">
                        <label for="phoneNumber">Phone Number</label>
                        <InputText id="phoneNumber" class="form-control" @bind-Value="_profile.PhoneNumber" />
                    </div>

                    <div class="form-group">
                        <label for="language">Preferred Language</label>
                        <InputSelect id="language" class="form-control" @bind-Value="_profile.PreferredLanguage">
                            <option value="en">English</option>
                            <option value="sn">Shona</option>
                            <option value="nd">Ndebele</option>
                        </InputSelect>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" disabled="@_isLoading">
                            @if (_isLoading)
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>Save Changes</span>
                            }
                        </button>
                        <button type="button" class="btn btn-secondary" @onclick="HandleChangePassword">
                            Change Password
                        </button>
                    </div>
                </EditForm>
            </div>

            @if (_showChangePassword)
            {
                <div class="profile-section">
                    <h2>Change Password</h2>
                    <EditForm Model="@_changePasswordRequest" OnValidSubmit="HandlePasswordChange">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <InputText type="password" id="currentPassword" class="form-control" 
                                     @bind-Value="_changePasswordRequest.CurrentPassword" />
                        </div>

                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <InputText type="password" id="newPassword" class="form-control" 
                                     @bind-Value="_changePasswordRequest.NewPassword" />
                            <small class="form-text text-muted">
                                Password must be at least 8 characters long and contain uppercase, lowercase, 
                                numbers, and special characters.
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="confirmPassword">Confirm New Password</label>
                            <InputText type="password" id="confirmPassword" class="form-control" 
                                     @bind-Value="_changePasswordRequest.ConfirmPassword" />
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" disabled="@_isChangingPassword">
                                @if (_isChangingPassword)
                                {
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    <span>Updating...</span>
                                }
                                else
                                {
                                    <span>Update Password</span>
                                }
                            </button>
                            <button type="button" class="btn btn-link" @onclick="() => _showChangePassword = false">
                                Cancel
                            </button>
                        </div>
                    </EditForm>
                </div>
            }
        </div>
    }
    else
    {
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
</div>

<style>
    .profile-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
    }

    .profile-header {
        margin-bottom: 2rem;
    }

    .profile-content {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .profile-section {
        padding: 2rem;
        border-bottom: 1px solid #e9ecef;
    }

    .profile-section:last-child {
        border-bottom: none;
    }

    .profile-picture {
        text-align: center;
        margin-bottom: 2rem;
    }

    .profile-picture img {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
    }

    .profile-picture-placeholder {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background-color: #7b1fa2;
        color: white;
        font-size: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .btn-primary {
        background-color: #7b1fa2;
        border-color: #7b1fa2;
    }

    .btn-primary:hover {
        background-color: #6a1b9a;
        border-color: #6a1b9a;
    }

    .btn-outline-primary {
        color: #7b1fa2;
        border-color: #7b1fa2;
    }

    .btn-outline-primary:hover {
        background-color: #7b1fa2;
        border-color: #7b1fa2;
        color: white;
    }

    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 200px;
    }

    .alert {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 4px;
    }

    .alert-success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }

    .alert-danger {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }

    .image-cropper-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        position: relative;
        background-color: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        max-width: 90%;
        width: 800px;
    }

    .modal-content h3 {
        margin-bottom: 1.5rem;
        color: #7b1fa2;
    }

    .image-filters-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
</style>

@code {
    private UserProfile? _profile;
    private ChangePasswordRequest _changePasswordRequest = new();
    private bool _isLoading;
    private bool _isChangingPassword;
    private bool _showChangePassword;
    private string? _successMessage;
    private string? _errorMessage;
    private bool _isUploadingPicture;
    private const int MaxFileSize = 5 * 1024 * 1024; // 5MB
    private const string AllowedExtensions = ".jpg,.jpeg,.png,.gif,.webp";
    private bool _showImageCropper;
    private string _selectedImageUrl = string.Empty;
    private bool _showImageFilters;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // TODO: Get actual user ID from claims
            var userId = "user-id";
            _profile = await AuthService.GetUserProfileAsync(userId);
        }
        catch (Exception ex)
        {
            _errorMessage = "Failed to load profile. Please try again.";
            Console.Error.WriteLine($"Error loading profile: {ex}");
        }
    }

    private async Task HandleUpdateProfile()
    {
        if (_profile == null) return;

        try
        {
            _isLoading = true;
            _errorMessage = null;
            _successMessage = null;

            // TODO: Get actual user ID from claims
            var userId = "user-id";
            var success = await AuthService.UpdateUserProfileAsync(userId, _profile);

            if (success)
            {
                _successMessage = "Profile updated successfully.";
            }
            else
            {
                _errorMessage = "Failed to update profile. Please try again.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "An unexpected error occurred. Please try again.";
            Console.Error.WriteLine($"Error updating profile: {ex}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task HandlePasswordChange()
    {
        try
        {
            _isChangingPassword = true;
            _errorMessage = null;
            _successMessage = null;

            // TODO: Get actual user ID from claims
            var userId = "user-id";
            var response = await AuthService.ChangePasswordAsync(userId, _changePasswordRequest);

            if (response.Successful)
            {
                _successMessage = "Password changed successfully.";
                _showChangePassword = false;
                _changePasswordRequest = new();
            }
            else
            {
                _errorMessage = response.Error ?? "Failed to change password. Please try again.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "An unexpected error occurred. Please try again.";
            Console.Error.WriteLine($"Error changing password: {ex}");
        }
        finally
        {
            _isChangingPassword = false;
        }
    }

    private void HandleChangePassword()
    {
        _showChangePassword = true;
        _errorMessage = null;
        _successMessage = null;
    }

    private void HandleUploadPicture()
    {
        var fileInput = Document.GetElementById("fileInput");
        if (fileInput != null)
        {
            fileInput.Click();
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file == null)
            {
                _errorMessage = "No file selected.";
                return;
            }

            // Validate file size
            if (file.Size > MaxFileSize)
            {
                _errorMessage = "File size must be less than 5MB.";
                return;
            }

            // Validate file type
            var extension = Path.GetExtension(file.Name).ToLowerInvariant();
            if (!AllowedExtensions.Contains(extension))
            {
                _errorMessage = "Only .jpg, .jpeg, .png, .gif, and .webp files are allowed.";
                return;
            }

            // Create a data URL for the image cropper
            var buffer = new byte[file.Size];
            await file.OpenReadStream(MaxFileSize).ReadAsync(buffer);
            var base64 = Convert.ToBase64String(buffer);
            var mimeType = file.ContentType;
            _selectedImageUrl = $"data:{mimeType};base64,{base64}";
            _showImageCropper = true;
        }
        catch (Exception ex)
        {
            _errorMessage = "An error occurred while processing the image.";
            Console.Error.WriteLine($"Error processing image: {ex}");
        }
    }

    private async Task HandleCropComplete(string croppedImageUrl)
    {
        _selectedImageUrl = croppedImageUrl;
        _showImageCropper = false;
        _showImageFilters = true;
    }

    private async Task HandleFilterComplete(string filteredImageUrl)
    {
        try
        {
            _isUploadingPicture = true;
            _errorMessage = null;
            _successMessage = null;

            // Convert data URL to stream
            var base64Data = filteredImageUrl.Split(',')[1];
            var imageBytes = Convert.FromBase64String(base64Data);
            var stream = new MemoryStream(imageBytes);

            var url = await ProfilePictureService.UploadProfilePictureAsync(stream, "profile.jpg");

            if (url != null)
            {
                _profile.ProfilePictureUrl = url;
                await HandleUpdateProfile();
                _successMessage = "Profile picture updated successfully.";
            }
            else
            {
                _errorMessage = "Failed to upload profile picture. Please try again.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "An error occurred while uploading the profile picture.";
            Console.Error.WriteLine($"Error uploading profile picture: {ex}");
        }
        finally
        {
            _isUploadingPicture = false;
            _showImageFilters = false;
        }
    }

    private string GetThumbnailUrl(string originalUrl)
    {
        // Add query parameter for CloudFront to generate thumbnail
        return $"{originalUrl}?w=50&q=50";
    }
} 